# Tail Match - プロジェクト状況管理

## 📚 ドキュメント

### 開発フェーズ

- **[スクレイピング実装ガイド](./.claude/scraping-guide.md)** - 新規自治体追加の完全な手順
- **[よくある間違い](./.claude/common-mistakes.md)** - 過去の失敗から学んだ教訓
- **[スクレイピングアーキテクチャ](./.claude/scraping-architecture.md)** - 技術設計・実装方針
- **[履歴ロガー統合ガイド](./.claude/history-logger-guide.md)** - スクレイピング履歴管理システム

### 運用フェーズ

- **[運用ガイド](./.claude/operations-guide.md)** - 日常運用・トラブルシューティング手順
- **[保護施設データベース](./.claude/shelters.yaml)** - 全78施設の情報（実装済み34＋未実装44）

### その他

- **[プロジェクトREADME](./README.md)** - プロジェクト全体の説明

---

## 🎯 **現在の状況** (2025-11-15更新)

### ✅ **Phase 4.1 完了成果** (2025-07-01)

- **インフラ完全現代化**:
  - **Docker Compose現代化**: `docker compose` + `.yaml` 形式統一
  - **CI/CDパイプライン**: GitHub Actions完備（テスト・ビルド・デプロイ）
  - **本番環境設定**: Nginx + SSL + 自動デプロイスクリプト
  - **環境変数管理**: 開発・本番環境分離
- **命名統一完了**:
  - **ブランド統一**: 「TailMatch」→「Tail Match」全ファイル対応
  - **User-Agent更新**: ライブラリベース形式で礼儀正しいスクレイピング
- **管理機能実装**:
  - **スクレイピング管理画面**: `/admin/scraping` タイムライン表示
  - **統計ダッシュボード**: 成功率・実行時間・発見数監視
  - **API体系**: ログ・統計エンドポイント完備
- **包括的ドキュメント**: README・設定ガイド・使用方法完備

### ✅ **継続完了機能**

- **基盤システム**: Next.js + PostgreSQL + Python スクレイピング環境完成
- **フロントエンド完成**: Phase 3 UI/UX実装完了
  - 検索・フィルタリング機能 (地域・性別・年齢・緊急度)
  - 緊急度表示システム (視覚的アラート・アニメーション)
  - 統計ダッシュボード (リアルタイム集計・地域別分布)
  - 猫詳細ページ (完全レスポンシブ・連絡先情報)
- **UI/UX機能**:
  - **フルワイドヒーローカルーセル**: 明るい猫写真で訪問者を歓迎
  - **ハンバーガーメニュー**: モバイル完全対応、全機能にアクセス可能
  - **宇宙猫ゲーム**: サイトを明るくする進化型クリッカーゲーム
  - **保護センター一覧**: 全国の保護施設情報を体系化
  - **MUI完全統一**: 一貫したデザインシステム実現

### ✅ **Phase 4.2-part スクレイパー共通化・命名規則統一完了** (2025-11-13)

- **共通ヘルパー関数**: 全34施設で統一ロジックを使用（譲渡済み判定・動物種判定）
  - 詳細は [スクレイピングアーキテクチャ](./.claude/scraping-architecture.md#汎用化完了) 参照
- **命名規則統一**: -cats/-dogs サフィックス完備（猫専用26 + 犬専用16 + 混在8）
  - 詳細は [実装ガイド](./.claude/scraping-guide.md#命名規則) 参照
- **犬用ページ実装**: 16施設で犬用スクレイパーを追加実装
- **ドキュメント更新**: 共通化・命名規則を各ガイドに反映

### ✅ **Phase 4.2-part2 履歴ロガー完全統合完了** (2025-11-13)

- **カウント継承システム実装**:
  - `history-logger.js` に `loadPreviousCounts()` メソッド実装
  - scrape.js → html-to-yaml.js → yaml-to-db.js の完全なパイプライン追跡
- **全施設ロガー統合**:
  - 34施設すべての html-to-yaml.js に logger.start() / loadPreviousCounts() / finalize() を統合
  - 自動一括更新スクリプト作成: `scripts/update-all-html-to-yaml-loggers.js`
- **自動不一致検出**:
  - HTML→YAML で1匹でも減少したら自動警告
  - YAML→DB で1匹でも減少したら自動警告
  - サマリー表示: `scripts/core/show-scraping-summary.js`
- **バグ修正**:
  - 千葉市: 全角・半角括弧混在問題を修正（17→15不一致を解消）
  - 詳細は [バグ修正ログ](./.claude/bugfix-log.md) 参照
- **運用準備完了**:
  - `scripts/core/run-all-scrapers.sh` でDB初期化→全施設スクレイピング→サマリー表示の完全自動化
  - 不一致検出率: 2.9%（1/34施設）

### ⚠️ **残存技術課題**

- **📋 データベース接続**: スクレイピング実行時の接続問題（要調査）
- **📋 Next.js設定**: standalone build設定が未完了

詳細は [scraping-architecture.md](./.claude/scraping-architecture.md) を参照。

### ✅ **Phase 4.3 法的整備完了** (2025-07-01)

- **法的ページ作成**: プライバシーポリシー・利用規約・免責事項
- **ユーザビリティ重視**: 簡潔版＋詳細版の2段構成
- **透明性確保**: 収集しない個人情報を明確に列挙
- **視覚的デザイン**: ✅❌アイコン・色分け・2カラムレイアウト
- **フッターリンク**: 全ページからアクセス可能

### 🚀 **優先実装順序** (Phase 4.4以降) - 2025-11-15更新

1. **🔥 HIGH**: 全国展開（残り55施設のスクレイパー実装）
   - 政令指定都市（新潟、静岡、浜松、名古屋、京都、岡山、北九州、福岡、熊本）
   - 県庁所在地（36都市）
   - 詳細は [shelters.yaml](./.claude/shelters.yaml) 参照
   - **✅ 完了**: 愛知県（3支所統合：猫・犬） (2025-11-15)
2. **📋 MED**: 管理画面APIエラー修正（スクレイピング履歴表示）
3. **📋 MED**: Database接続修正
4. **📋 MED**: Next.js standalone build設定
5. **📋 LOW**: 堺市・横浜市の完全自動化（画像OCR統合 or HTML化）

**解決済み（2025-11-15）**:

- ✅ Playwright動的スクレイピング実装（全34スクレイパー）
- ✅ 実データ取得システム構築（html-to-yaml.js、全34スクレイパー）
- ✅ JavaScriptサイト対応（5秒待機、全34スクレイパー）
- ✅ フォールバック抽出問題の解決（実データ取得に移行）
- ✅ 犬用ページの実装（11施設）
- ✅ 譲渡済み判定の統一（34スクレイパー）
- ✅ 動物種判定の強化（愛称表記対応）
- ✅ 共通ヘルパー関数の実装（adoption-status.js、animal-type.js）
- ✅ 犬用ページの完全無視問題（11施設）
- ✅ status（譲渡済み）フィールド未実装問題（34スクレイパー）
- ✅ 「ワンちゃん」「わんちゃん」表記漏れ問題
- ✅ 履歴ロガー統合（全34スクレイパー、HTML→YAML→DB不一致検出）
- ✅ 運用スクリプト作成（`scripts/core/run-all-scrapers.sh`）
- ✅ 運用ドキュメント作成（`.claude/operations-guide.md`）
- ✅ 定期実行・監視システム（cron設定手順、ログ確認、エラー通知）

---

## 実装記録

**Phase 1**: 基盤構築 ✅ 完了 (2024-12-30)
**Phase 2**: スクレイピングシステム ✅ 完了 (2025-11-15) - 3ステップパイプライン確立
**Phase 3**: UI/UX完成 ✅ 完了 (2024-06-30) - ヒーローカルーセル・ハンバーガーメニュー・宇宙猫ゲーム追加
**Phase 4.1**: インフラ現代化 ✅ 完了 (2025-07-01) - Docker現代化・CI/CD・管理画面完備
**Phase 4.3**: 法的整備 ✅ 完了 (2025-07-01) - プライバシーポリシー・利用規約・免責事項
**Phase 4.2-part**: スクレイパー共通化・命名規則統一 ✅ 完了 (2025-11-13)
**Phase 4.2**: 複数自治体対応 🔄 **進行中** - 20都道府県、34施設、50スクレイパー実装済み（43.6%）

---

## 🔄 次回セッション用サマリー (2025-11-15作成)

### 直前の作業内容

**四国地方完成（2025-11-15）:**

1. **徳島県動物愛護管理センター（猫・犬）** `tokushima/tokushima-pref-{cats,dogs}`
   - iframe内テーブル形式、rowspan対応パース、全角数字→半角変換、データ: 猫1匹・犬10匹

2. **愛媛県動物愛護センター** `ehime/ehime-pref`
   - 犬猫混在ページ、caption基準セクション分割、テーブル形式、データ: 猫10匹・犬15匹

3. **高知県中央・中村小動物管理センター** `kochi/kochi-pref`
   - 犬猫混在ページ、カード形式、tab-listリンクから動物種判定、重複除去（猫優先）、データ: 猫14匹・犬26匹

### 実装済み都道府県（20/47）

北海道、宮城、東京、埼玉、千葉、神奈川、富山、石川、福井、愛知、京都、大阪、兵庫、広島、福岡、香川、徳島、**愛媛**、**高知**、沖縄

### 次の作業

**全国展開継続:**

- 残り27都府県（55施設）の実装
- 優先: 政令指定都市、県庁所在地

進捗: 20都道府県、34施設、50スクレイパー実装済み（43.6%）

### 技術的成果

- **全角数字→半角変換**: `detailText.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xfee0))`
- **rowspan対応パース**: th行の次行のtdを参照する処理実装
- **iframe内データ抽出**: 親ページではなくiframe URLを直接スクレイピング
- **caption基準セクション分割**: table captionの内容で猫/犬を判定（愛媛県）
- **tab-listリンクから動物種判定**: URLパラメータ（maigojouto_cat）から猫/犬を判定（高知県）
- **重複除去（猫優先）**: external_idで重複除去、猫を優先保持（高知県）

### 重要な学び

1. iframe構造のサイトは親ページではなくiframe URLを直接スクレイピング
2. 全角数字を使う自治体は `replace(/[０-９]/g, ...)` で対応
3. rowspanがある表は次行のtdを参照する処理が必要
4. caption要素で猫/犬セクションを判定できるテーブルがある
5. tab-listやURLパラメータから動物種情報を取得できる場合がある
6. 複数タブで同一動物が重複する場合、external_idで重複除去し、猫を優先
7. 整理は `scripts/core/cleanup-html-yaml.js` で自動化済み
8. コミットは: スクレイパーコード → データファイル（整理後）の2段階
