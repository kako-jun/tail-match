#!/bin/bash

# ================================================================
# 横浜市動物愛護センター 完全自動スクレイピングスクリプト
# ================================================================
#
# 使用方法:
#   ./scripts/scrapers/kanagawa/yokohama-city/run-full-scrape.sh
#
# 実行内容:
#   1. 譲渡猫ページのHTMLをスクレイピング
#   2. 画像URLを抽出
#   3. 画像をダウンロード
#   4. YAMLテンプレートを生成
#   5. （手動）Claude Vision APIで画像情報を抽出してYAML更新
#
# ================================================================

set -e  # エラーで停止

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../../.." && pwd)"
cd "$PROJECT_ROOT"

echo "============================================================"
echo "🐱 横浜市動物愛護センター - 完全自動スクレイピング"
echo "============================================================"
echo ""

# ================================================================
# Step 1: HTMLをスクレイピング
# ================================================================

echo "[Step 1] 譲渡猫ページのHTMLをスクレイピング中..."

node "$SCRIPT_DIR/scrape.js"

echo ""

# ================================================================
# Step 2: 画像URLを抽出してダウンロード
# ================================================================

echo "[Step 2] 画像URLを抽出してダウンロード中..."

node "$SCRIPT_DIR/extract-from-images.js"

echo ""

# ================================================================
# Step 3: 画像から情報を抽出してYAML更新
# ================================================================

echo "[Step 3] 画像から情報を抽出してYAML更新中..."
echo ""
echo "⚠️  注意: update-yaml-from-images.js の extractedData を確認してください"
echo "    新しい猫が追加されている場合は、手動で情報を追加する必要があります"
echo ""

read -p "update-yaml-from-images.js を実行しますか？ (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  node "$SCRIPT_DIR/update-yaml-from-images.js"
else
  echo "  スキップしました"
  echo "  後で手動で実行してください: node scripts/scrapers/kanagawa/yokohama-city/update-yaml-from-images.js"
fi

echo ""

# ================================================================
# 完了
# ================================================================

echo "============================================================"
echo "✅ 自動スクレイピング完了"
echo "============================================================"
echo ""
echo "次のステップ:"
echo "  1. data/images/kanagawa/yokohama-city/ の画像を確認"
echo "  2. 必要に応じて update-yaml-from-images.js の extractedData を更新"
echo "  3. データベースに投入:"
echo "     node scripts/yaml-to-db.js"
echo ""
